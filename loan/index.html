<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Loan Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #4895ef;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
            --bg-color: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            --text-color: var(--dark);
            --header-bg: var(--gradient);
            --header-text: white;
            --card-bg: white;
            --input-border: #e9ecef;
            --input-focus-shadow: rgba(67, 97, 238, 0.2);
            --slider-bg: #e9ecef;
            --slider-thumb: var(--primary);
            --table-header-bg: var(--primary);
            --table-header-text: white;
            --table-row-even: #f8f9fa;
            --table-row-hover: #e9ecef;
            --tax-info-bg: #e8f4fc;
            --tax-info-border: var(--info);
            --toggle-bg: var(--light);
            --toggle-hover-bg: #e9ecef;
            --savings-highlight-bg: var(--success);
            --savings-highlight-shadow: rgba(76, 201, 240, 0.3);
        }

        body.dark-mode {
            --bg-color: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --text-color: #ecf0f1;
            --header-bg: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            --header-text: white;
            --card-bg: #3b4f63;
            --input-border: #5a6f82;
            --input-focus-shadow: rgba(100, 149, 237, 0.3);
            --slider-bg: #5a6f82;
            --slider-thumb: #6495ed;
            --table-header-bg: #6495ed;
            --table-header-text: white;
            --table-row-even: #4a5f73;
            --table-row-hover: #5a6f82;
            --tax-info-bg: #4a5f73;
            --tax-info-border: #6495ed;
            --toggle-bg: #4a5f73;
            --toggle-hover-bg: #5a6f73;
            --savings-highlight-bg: #6495ed;
            --savings-highlight-shadow: rgba(100, 149, 237, 0.3);
            --primary: #6495ed;
            --secondary: #4682b4;
            --accent: #8a2be2;
            color: var(--text-color);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', sans-serif;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            transition: background 0.5s ease, color 0.5s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--header-bg);
            color: var(--header-text);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 60%);
            transform: rotate(30deg);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            line-height: 80px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            color: white;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 25px;
            gap: 0;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .tab-btn {
            padding: 16px 25px;
            background: var(--light);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
            border-bottom: 3px solid transparent;
            color: var(--dark);
        }
        
        .tab-btn.active {
            background: var(--card-bg);
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab-btn:hover {
            background: var(--toggle-hover-bg);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .calculator-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .calculator-container {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
        
        .input-section, .result-section, .section-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }
        
        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--input-border);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
        }
        
        .slider-container {
            margin-top: 15px;
        }
        
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: var(--slider-bg);
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--slider-thumb);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 0 0 4px var(--input-focus-shadow);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--slider-thumb);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 0 0 4px var(--input-focus-shadow);
        }
        
        .slider-values {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        button {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
        }

        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .export-buttons button {
            width: auto;
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .result-card {
            text-align: center;
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
            transition: background 0.5s ease;
        }
        
        .result-title {
            font-size: 18px;
            color: var(--text-color);
            margin-bottom: 15px;
        }
        
        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .summary-item {
            background: var(--light);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            transition: var(--transition), background 0.5s ease;
        }
        
        .summary-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .summary-title {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 8px;
        }
        
        .summary-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .schedule-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow-x: auto;
            transition: background 0.5s ease;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--input-border);
            color: var(--text-color);
        }
        
        th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: var(--table-row-even);
        }
        
        tr:hover {
            background-color: var(--table-row-hover);
        }
        
        .chart-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            transition: background 0.5s ease;
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        .chart {
            display: flex;
            height: 300px;
            justify-content: center;
            align-items: center;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 30px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: var(--light);
            border-radius: 30px;
            transition: background 0.5s ease;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .principal-color {
            background: var(--primary);
        }
        
        .interest-color {
            background: var(--accent);
        }
        
        .advanced-options {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            transition: background 0.5s ease;
        }
        
        .option-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            padding: 15px;
            background: var(--toggle-bg);
            border-radius: var(--border-radius);
            transition: var(--transition), background 0.5s ease;
        }
        
        .option-toggle:hover {
            background: var(--toggle-hover-bg);
        }
        
        .option-toggle i {
            margin-right: 15px;
            transition: var(--transition);
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .option-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
            padding-top: 0;
        }
        
        .option-content.active {
            max-height: 1000px;
            padding-top: 20px;
        }
        
        .scenario-box {
            background: var(--light);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            transition: var(--transition), background 0.5s ease;
            border-left: 5px solid var(--info);
        }
        
        .scenario-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .scenario-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .savings-highlight {
            background: var(--savings-highlight-bg);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-top: 20px;
            font-weight: 600;
            box-shadow: 0 5px 15px var(--savings-highlight-shadow);
            transition: background 0.5s ease;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 14px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: background 0.5s ease, color 0.5s ease;
        }
        
        .tax-info {
            background: var(--tax-info-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border-left: 5px solid var(--tax-info-border);
            transition: background 0.5s ease;
        }
        
        .variable-rate-table, .prepayment-table, .loan-portfolio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .variable-rate-table th, .prepayment-table th, .loan-portfolio-table th {
            background: var(--accent);
        }

        .variable-rate-table td, .prepayment-table td, .loan-portfolio-table td {
            vertical-align: middle;
        }

        .variable-rate-table input, .prepayment-table input, .loan-portfolio-table input, .loan-portfolio-table select {
            padding: 8px;
            font-size: 14px;
            border-radius: 8px;
        }

        .variable-rate-table button, .prepayment-table button, .loan-portfolio-table button {
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
            margin: 0;
            box-shadow: none;
        }
        
        .add-rate-row, .add-prepayment-row, .add-loan-row {
            margin-top: 15px;
            background: var(--info);
            width: auto;
            padding: 10px 20px;
        }
        
        .input-icon {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .heatmap-container {
            margin-top: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-x: auto;
            transition: background 0.5s ease;
        }

        .heatmap-grid {
            display: grid;
            gap: 2px;
            padding: 5px;
            background: var(--light);
            border-radius: var(--border-radius);
        }

        .heatmap-cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            border-radius: 3px;
            transition: background-color 0.3s ease;
        }

        .heatmap-header {
            font-weight: bold;
            background: none !important;
            color: var(--text-color) !important;
            font-size: 0.8em;
        }

        .heatmap-row-label {
            text-align: right;
            padding-right: 5px;
            font-weight: bold;
            color: var(--text-color);
            font-size: 0.8em;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark) transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .progress-bar-container {
            width: 100%;
            background-color: var(--light);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-bar {
            height: 20px;
            background-color: var(--primary);
            width: 0%;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-size: 0.8em;
            line-height: 20px;
            transition: width 0.5s ease-in-out;
        }

        .scenario-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .scenario-column {
            background: var(--light);
            padding: 20px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary);
            transition: background 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="dark-mode-toggle" id="darkModeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <div class="logo">
                <i class="fas fa-calculator"></i>
            </div>
            <h1>Advanced Loan Calculator</h1>
            <p class="subtitle">Calculate EMI, interest, tax benefits, and explore various scenarios with our comprehensive loan calculator</p>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="basic">
                <i class="fas fa-calculator"></i> Basic Calculator
            </button>
            <button class="tab-btn" data-tab="home-loan">
                <i class="fas fa-home"></i> Home Loan + Tax
            </button>
            <button class="tab-btn" data-tab="scenarios">
                <i class="fas fa-chart-line"></i> What-If Scenarios
            </button>
            <button class="tab-btn" data-tab="portfolio">
                <i class="fas fa-layer-group"></i> Loan Portfolio
            </button>
            <button class="tab-btn" data-tab="affordability">
                <i class="fas fa-hand-holding-usd"></i> Affordability
            </button>
            <button class="tab-btn" data-tab="advanced">
                <i class="fas fa-cogs"></i> Advanced Options
            </button>
        </div>
        
        <div class="tab-content active" id="basic">
            <div class="calculator-container">
                <div class="input-section">
                    <h2 class="section-title">
                        <i class="fas fa-sliders-h"></i> Loan Details
                    </h2>
                    <div class="form-group">
                        <label for="loanAmount">
                            <i class="fas fa-indian-rupee-sign input-icon"></i> Loan Amount (₹)
                        </label>
                        <input type="number" id="loanAmount" min="1000" max="100000000" step="1000" value="1000000">
                        <div class="slider-container">
                            <input type="range" min="1000" max="10000000" value="1000000" class="slider" id="loanAmountSlider">
                            <div class="slider-values">
                                <span>₹1,000</span>
                                <span>₹1,00,00,000</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="interestRate">
                            <i class="fas fa-percent input-icon"></i> Interest Rate (% per annum)
                        </label>
                        <input type="number" id="interestRate" min="1" max="30" step="0.1" value="8.5">
                        <div class="slider-container">
                            <input type="range" min="1" max="30" step="0.1" value="8.5" class="slider" id="interestRateSlider">
                            <div class="slider-values">
                                <span>1%</span>
                                <span>30%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="loanTenure">
                            <i class="fas fa-calendar-alt input-icon"></i> Loan Tenure
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="loanTenure" min="1" step="1" value="20" style="flex: 2;">
                            <select id="loanTenureType" style="flex: 1; padding: 15px; border: 2px solid var(--input-border); border-radius: var(--border-radius); font-size: 16px; background: var(--card-bg); color: var(--text-color);">
                                <option value="years" selected>Years</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="1" max="30" value="20" class="slider" id="loanTenureSlider">
                            <div class="slider-values" id="loanTenureSliderValues">
                                <span>1 Year</span>
                                <span>30 Years</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="compoundingFrequency">
                            <i class="fas fa-history input-icon"></i> Compounding Frequency
                        </label>
                        <select id="compoundingFrequency">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="half-yearly">Half-Yearly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    
                    <button id="calculateBtn">
                        <i class="fas fa-calculator"></i> Calculate EMI
                    </button>
                </div>
                
                <div class="result-section">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie"></i> Loan Summary
                    </h2>
                    <div class="result-card">
                        <div class="result-title">Monthly EMI</div>
                        <div class="result-value" id="emiValue">₹8,650</div>
                    </div>
                    
                    <div class="result-grid">
                        <div class="summary-item">
                            <div class="summary-title">Total Interest Payable</div>
                            <div class="summary-value" id="totalInterest">₹10,76,000</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">Total Payment</div>
                            <div class="summary-value" id="totalPayment">₹20,76,000</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">Interest Percentage</div>
                            <div class="summary-value" id="interestPercent">51.8%</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">Number of EMIs</div>
                            <div class="summary-value" id="numberOfEmis">240</div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="loanProgressBar">0% Repaid</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Payment Breakdown</div>
                <canvas id="paymentBreakdownChart"></canvas>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color principal-color"></div>
                        <span>Principal Amount</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color interest-color"></div>
                        <span>Interest Amount</span>
                    </div>
                </div>
            </div>
            
            <div class="schedule-section">
                <h2 class="section-title">
                    <i class="fas fa-table"></i> Amortization Schedule
                </h2>
                <div id="scheduleTableContainer">
                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th>Payment No.</th>
                                <th>EMI Amount</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Total Interest</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            </tbody>
                    </table>
                </div>
                <div class="export-buttons">
                    <button id="exportTxtBtn"><i class="fas fa-file-alt"></i> Export as TXT</button>
                    <button id="exportCsvBtn"><i class="fas fa-file-csv"></i> Export as CSV</button>
                    <button id="exportMdBtn"><i class="fab fa-markdown"></i> Export as MD</button>
                    <button id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                </div>
            </div>

            <div class="heatmap-container">
                <h2 class="section-title">
                    <i class="fas fa-th-large"></i> Amortization Heatmap (Interest Paid)
                </h2>
                <div id="interestHeatmap" class="heatmap-grid"></div>
            </div>
        </div>
        
        <div class="tab-content" id="home-loan">
            <div class="tax-info">
                <h3><i class="fas fa-info-circle"></i> Home Loan Tax Benefits in India</h3>
                <p>Under Section 80C: Deduction up to ₹1.5 lakh for principal repayment</p>
                <p>Under Section 24(b): Deduction up to ₹2 lakh for interest payment</p>
            </div>
            
            <div class="calculator-container">
                <div class="input-section">
                    <h2 class="section-title">
                        <i class="fas fa-home"></i> Home Loan Details
                    </h2>
                    <div class="form-group">
                        <label for="hlLoanAmount">
                            <i class="fas fa-indian-rupee-sign input-icon"></i> Loan Amount (₹)
                        </label>
                        <input type="number" id="hlLoanAmount" value="5000000">
                    </div>
                    
                    <div class="form-group">
                        <label for="hlInterestRate">
                            <i class="fas fa-percent input-icon"></i> Interest Rate (% p.a.)
                        </label>
                        <input type="number" id="hlInterestRate" value="8.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="hlTenure">
                            <i class="fas fa-calendar-alt input-icon"></i> Loan Tenure
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="hlTenure" value="20" style="flex: 2;">
                            <select id="hlTenureType" style="flex: 1; padding: 15px; border: 2px solid var(--input-border); border-radius: var(--border-radius); font-size: 16px; background: var(--card-bg); color: var(--text-color);">
                                <option value="years" selected>Years</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="annualIncome">
                            <i class="fas fa-money-bill-wave input-icon"></i> Annual Income (₹)
                        </label>
                        <input type="number" id="annualIncome" value="1500000">
                    </div>
                    
                    <div class="form-group">
                        <label for="taxSlab">
                            <i class="fas fa-percent input-icon"></i> Tax Slab
                        </label>
                        <select id="taxSlab">
                            <option value="0.05">Up to ₹3 lakh (5%)</option>
                            <option value="0.10">₹3-6 lakh (10%)</option>
                            <option value="0.15">₹6-9 lakh (15%)</option>
                            <option value="0.20">₹9-12 lakh (20%)</option>
                            <option value="0.25">₹12-15 lakh (25%)</option>
                            <option value="0.30" selected>Above ₹15 lakh (30%)</option>
                        </select>
                    </div>
                    
                    <button id="calculateHlBtn">
                        <i class="fas fa-calculator"></i> Calculate Tax Benefits
                    </button>
                </div>
                
                <div class="result-section">
                    <h2 class="section-title">
                        <i class="fas fa-receipt"></i> Tax Benefits Summary
                    </h2>
                    <div class="result-card">
                        <div class="result-title">Yearly Tax Saving</div>
                        <div class="result-value" id="yearlyTaxSaving">₹72,500</div>
                    </div>
                    
                    <div class="result-grid">
                        <div class="summary-item">
                            <div class="summary-title">Principal (80C)</div>
                            <div class="summary-value" id="principal80C">₹1,50,000</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">Interest (24b)</div>
                            <div class="summary-value" id="interest24b">₹2,00,000</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">Total Deduction</div>
                            <div class="summary-value" id="totalDeduction">₹3,50,000</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">Effective Interest Rate</div>
                            <div class="summary-value" id="effectiveRate">6.2%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="scenarios">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i> What-If Scenarios
            </h2>
            
            <div class="scenario-box">
                <div class="scenario-title">
                    <i class="fas fa-arrow-up"></i> Increase EMI by
                </div>
                <div class="form-group">
                    <label for="extraEmi">Extra EMI Amount (₹)</label>
                    <input type="number" id="extraEmi" value="1000" min="0" step="500">
                </div>
                <button id="calculateEmiScenario">
                    <i class="fas fa-calculator"></i> Calculate Impact
                </button>
                <div class="savings-highlight" id="emiSavings"></div>
            </div>
            
            <div class="scenario-box">
                <div class="scenario-title">
                    <i class="fas fa-money-bill-wave"></i> One-time Prepayment of
                </div>
                <div class="form-group">
                    <label for="prepaymentAmount">Prepayment Amount (₹)</label>
                    <input type="number" id="prepaymentAmount" value="300000" min="0" step="10000">
                </div>
                <button id="calculatePrepaymentScenario">
                    <i class="fas fa-calculator"></i> Calculate Impact
                </button>
                <div class="savings-highlight" id="prepaymentSavings"></div>
            </div>

            <div class="scenario-box">
                <div class="scenario-title">
                    <i class="fas fa-piggy-bank"></i> Early Closure Analysis
                </div>
                <div class="form-group">
                    <label for="earlyClosurePrepayment">Prepayment for Analysis (₹)</label>
                    <input type="number" id="earlyClosurePrepayment" value="100000" min="0" step="10000">
                </div>
                <button id="calculateEarlyClosure">
                    <i class="fas fa-calculator"></i> Analyze Early Closure
                </button>
                <div class="savings-highlight" id="earlyClosureResult"></div>
            </div>
            
            <div class="scenario-box">
                <div class="scenario-title">
                    <i class="fas fa-chart-line"></i> Inflation Adjusted Real Cost
                </div>
                <div class="form-group">
                    <label for="inflationRate">Expected Inflation Rate (%)</label>
                    <input type="number" id="inflationRate" value="5" min="0" step="0.1">
                </div>
                <button id="calculateInflationScenario">
                    <i class="fas fa-calculator"></i> Calculate Real Cost
                </button>
                <div class="savings-highlight" id="inflationImpact"></div>
            </div>

            <div class="scenario-box">
                <div class="scenario-title">
                    <i class="fas fa-sync-alt"></i> Refinance / Balance Transfer
                </div>
                <div class="form-group">
                    <label for="refinanceAfterYears">Refinance After (Years)</label>
                    <input type="number" id="refinanceAfterYears" value="3" min="1" step="1">
                </div>
                <div class="form-group">
                    <label for="newRefinanceRate">New Interest Rate (%)</label>
                    <input type="number" id="newRefinanceRate" value="7.0" min="1" step="0.1">
                </div>
                <div class="form-group">
                    <label for="newRefinanceTenure">New Tenure (Years)</label>
                    <input type="number" id="newRefinanceTenure" value="10" min="1" step="1">
                </div>
                <button id="calculateRefinanceScenario">
                    <i class="fas fa-calculator"></i> Analyze Refinance
                </button>
                <div class="savings-highlight" id="refinanceSavings"></div>
            </div>

            <div class="scenario-box">
                <div class="scenario-title">
                    <i class="fas fa-percent"></i> Interest Rate Change Scenario
                </div>
                <div class="form-group">
                    <label for="rateChangeAfterYears">Rate Changes After (Years)</label>
                    <input type="number" id="rateChangeAfterYears" value="2" min="1" step="1">
                </div>
                <div class="form-group">
                    <label for="newRateAfterChange">New Interest Rate (%)</label>
                    <input type="number" id="newRateAfterChange" value="9.0" min="1" step="0.1">
                </div>
                <button id="calculateRateChangeScenario">
                    <i class="fas fa-calculator"></i> Analyze Rate Change
                </button>
                <div class="savings-highlight" id="rateChangeImpact"></div>
            </div>
        </div>

        <div class="tab-content" id="portfolio">
            <h2 class="section-title">
                <i class="fas fa-layer-group"></i> Loan Portfolio Management
            </h2>
            <p>Add multiple loans to see your total monthly EMI burden.</p>

            <div class="section-card">
                <h3 class="section-title">Your Loans</h3>
                <table class="loan-portfolio-table">
                    <thead>
                        <tr>
                            <th>Loan Name</th>
                            <th>Amount (₹)</th>
                            <th>Rate (%)</th>
                            <th>Tenure</th>
                            <th>Compounding</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                        <tr>
                            <td><input type="text" value="Home Loan"></td>
                            <td><input type="number" value="5000000" min="1000"></td>
                            <td><input type="number" value="8.0" step="0.1" min="1"></td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <input type="number" value="20" min="1" style="flex: 2;">
                                    <select style="flex: 1; padding: 8px; font-size: 14px; border-radius: 8px;">
                                        <option value="years" selected>Years</option>
                                        <option value="months">Months</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                <select>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="half-yearly">Half-Yearly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </td>
                            <td><button class="remove-loan-row"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                <button class="add-loan-row"><i class="fas fa-plus"></i> Add New Loan</button>
                <button id="calculatePortfolioBtn" style="margin-top: 20px;">
                    <i class="fas fa-calculator"></i> Calculate Portfolio EMI
                </button>
            </div>

            <div class="result-section" style="margin-top: 30px;">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i> Portfolio Summary
                </h2>
                <div class="result-card">
                    <div class="result-title">Total Monthly EMI Burden</div>
                    <div class="result-value" id="totalPortfolioEmi">₹0</div>
                </div>
                <div class="result-grid">
                    <div class="summary-item">
                        <div class="summary-title">Total Loans</div>
                        <div class="summary-value" id="portfolioLoanCount">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-title">Longest Tenure</div>
                        <div class="summary-value" id="portfolioLongestTenure">0 Years</div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2 class="section-title">
                    <i class="fas fa-chart-area"></i> Monthly EMI Outflow (Stacked)
                </h2>
                <canvas id="portfolioEmiChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="affordability">
            <div class="calculator-container">
                <div class="input-section">
                    <h2 class="section-title">
                        <i class="fas fa-hand-holding-usd"></i> Affordability Calculator
                    </h2>
                    <div class="form-group">
                        <label for="affordableEmi">
                            <i class="fas fa-indian-rupee-sign input-icon"></i> Your Affordable Monthly EMI (₹)
                        </label>
                        <input type="number" id="affordableEmi" value="25000" min="1000">
                    </div>
                    <div class="form-group">
                        <label for="affordabilityInterestRate">
                            <i class="fas fa-percent input-icon"></i> Expected Interest Rate (% p.a.)
                        </label>
                        <input type="number" id="affordabilityInterestRate" value="8.5" min="1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="affordabilityTenure">
                            <i class="fas fa-calendar-alt input-icon"></i> Desired Loan Tenure
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="affordabilityTenure" value="20" min="1" style="flex: 2;">
                            <select id="affordabilityTenureType" style="flex: 1; padding: 15px; border: 2px solid var(--input-border); border-radius: var(--border-radius); font-size: 16px; background: var(--card-bg); color: var(--text-color);">
                                <option value="years" selected>Years</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                    </div>
                    <button id="calculateAffordableLoanBtn">
                        <i class="fas fa-calculator"></i> Calculate Affordable Loan
                    </button>
                </div>
                <div class="result-section">
                    <h2 class="section-title">
                        <i class="fas fa-money-check-alt"></i> Loan Affordability
                    </h2>
                    <div class="result-card">
                        <div class="result-title">Maximum Loan Amount You Can Afford</div>
                        <div class="result-value" id="maxAffordableLoan">₹0</div>
                    </div>
                    <div class="result-grid">
                        <div class="summary-item">
                            <div class="summary-title">Total Interest Paid</div>
                            <div class="summary-value" id="affordableTotalInterest">₹0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">Total Payment</div>
                            <div class="summary-value" id="affordableTotalPayment">₹0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card" style="margin-top: 30px;">
                <h2 class="section-title">
                    <i class="fas fa-chart-pie"></i> Debt-to-Income (DTI) Ratio & Eligibility
                </h2>
                <div class="form-group">
                    <label for="monthlyIncome">
                        <i class="fas fa-wallet input-icon"></i> Your Monthly Income (₹)
                    </label>
                    <input type="number" id="monthlyIncome" value="100000" min="1000">
                </div>
                <button id="calculateDtiBtn">
                    <i class="fas fa-calculator"></i> Calculate DTI
                </button>
                <div class="result-card" style="margin-top: 20px;">
                    <div class="result-title">Your Current EMI Burden (from Basic Calculator)</div>
                    <div class="result-value" id="currentEmiForDti">₹0</div>
                </div>
                <div class="result-card" style="margin-top: 20px;">
                    <div class="result-title">Your Debt-to-Income (DTI) Ratio</div>
                    <div class="result-value" id="dtiRatio">0%</div>
                </div>
                <div class="savings-highlight" id="dtiRiskAssessment" style="background: var(--info);"></div>
            </div>
        </div>
        
        <div class="tab-content" id="advanced">
            <h2 class="section-title">
                <i class="fas fa-cogs"></i> Advanced Loan Options
            </h2>
            
            <div class="advanced-options">
                <div class="option-toggle" id="balloonOption">
                    <i class="fas fa-chevron-right"></i>
                    <h3>Balloon Payment</h3>
                </div>
                <div class="option-content" id="balloonContent">
                    <div class="form-group">
                        <label for="balloonPayment">Balloon Payment Amount (₹)</label>
                        <input type="number" id="balloonPayment" value="0">
                    </div>
                    <p>A balloon payment is a large payment due at the end of your loan term.</p>
                </div>
            </div>
            
            <div class="advanced-options">
                <div class="option-toggle" id="variableOption">
                    <i class="fas fa-chevron-right"></i>
                    <h3>Variable Interest Rate Timeline</h3>
                </div>
                <div class="option-content" id="variableContent">
                    <table class="variable-rate-table">
                        <thead>
                            <tr>
                                <th>From Year</th>
                                <th>To Year</th>
                                <th>Interest Rate (%)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="variableRateBody">
                            </tbody>
                    </table>
                    <button class="add-rate-row"><i class="fas fa-plus"></i> Add Rate Period</button>
                </div>
            </div>
            
            <div class="advanced-options">
                <div class="option-toggle" id="prepaymentOption">
                    <i class="fas fa-chevron-right"></i>
                    <h3>Recurring Prepayments</h3>
                </div>
                <div class="option-content" id="prepaymentContent">
                    <table class="prepayment-table">
                        <thead>
                            <tr>
                                <th>Start After (Months)</th>
                                <th>Frequency</th>
                                <th>Amount (₹)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="prepaymentBody">
                            </tbody>
                    </table>
                    <button class="add-prepayment-row"><i class="fas fa-plus"></i> Add Prepayment</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Disclaimer: This calculator provides approximate values for reference purposes only. Actual loan terms may vary depending on the lender's policies.</p>
            <p>
                <button id="saveToGoogleSheetsBtn" style="margin-top: 20px; background: #4285F4; font-size: 16px;">
                    <i class="fas fa-file-excel"></i> Save to Google Sheets
                </button>
                <div id="googleSheetsStatus" style="margin-top: 15px; font-weight: 600; padding: 10px; border-radius: 8px; text-align: center;"></div>
                <span class="tooltip">
                    <i class="fas fa-info-circle"></i> API Mode
                    <span class="tooltiptext">This calculator's logic can be exposed as an API for integration into other fintech applications. (Requires backend development)</span>
                </span>
            </p>
            <p>© <span id="currentYear"></span> Made with Love by PRIYANSH</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
// Configuration variables
let CLIENT_ID = '';
let API_KEY = '';

async function loadConfig() {
    try {
        const response = await fetch('/api/config');
        const config = await response.json();
        CLIENT_ID = config.clientId;
        API_KEY = config.apiKey;
        console.log('Configuration loaded from server successfully');
    } catch (error) {
        console.error('Failed to load configuration:', error);
    }
}

// Google Sheets API Configuration
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

let tokenClient;
let gapiInited = false;
let gisInited = false;
let isAuthenticated = false;

function initializeGoogleAPIs() {
    return new Promise(async (resolve, reject) => {
        await loadConfig();
        
        gapi.load('client', function() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(function() {
                gapiInited = true;
                console.log('Google API client initialized successfully!');
                
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            isAuthenticated = true;
                            updateGoogleSheetsStatus('Authenticated successfully!', 'success');
                            resolve(true);
                        } else {
                            updateGoogleSheetsStatus('Authentication failed or was canceled.', 'error');
                            reject(new Error('Authentication failed'));
                        }
                    },
                });
                
                gisInited = true;
                if (!isAuthenticated) {
                    tokenClient.requestAccessToken();
                }
            }).catch(function(error) {
                updateGoogleSheetsStatus(`Error initializing Google API: ${error.message}`, 'error');
                reject(error);
            });
        });
    });
}

function updateGoogleSheetsStatus(message, type) {
    const statusElement = document.getElementById('googleSheetsStatus');
    if (statusElement) {
        statusElement.innerHTML = message;
        if (type === 'success') {
            statusElement.style.backgroundColor = '#E8F5E9';
            statusElement.style.color = '#2E7D32';
            statusElement.style.border = '1px solid #4CAF50';
        } else if (type === 'error') {
            statusElement.style.backgroundColor = '#FFEBEE';
            statusElement.style.color = '#C62828';
            statusElement.style.border = '1px solid #F44336';
        } else {
            statusElement.style.backgroundColor = '#E3F2FD';
            statusElement.style.color = '#1565C0';
            statusElement.style.border = '1px solid #2196F3';
        }
    }
}

async function saveToGoogleSheets() {
    if (!isAuthenticated) {
        updateGoogleSheetsStatus('Initializing Google APIs...', 'loading');
        try {
            await initializeGoogleAPIs();
        } catch (error) {
            updateGoogleSheetsStatus('Failed to initialize Google APIs', 'error');
            return;
        }
    }

    updateGoogleSheetsStatus('Saving to Google Sheets...', 'loading');

    try {
        const spreadsheetResponse = await gapi.client.sheets.spreadsheets.create({
            properties: {
                title: `Loan Calculator Results - ${new Date().toLocaleDateString()}`
            }
        });

        const spreadsheetId = spreadsheetResponse.result.spreadsheetId;
        const loanData = getCurrentLoanData();
        
        const values = [
            ['Loan Calculator Results', '', '', '', '', ''],
            ['Generated on :', new Date().toLocaleString(), '', '', '', ''],
            ['', '', '', '', '', ''],
            ['Basic Loan Details', '', '', '', '', ''],
            ['Loan Amount (₹) :', loanData.loanAmount, '', '', '', ''],
            ['Interest Rate (%) :', loanData.interestRate, '', '', '', ''],
            ['Loan Tenure :', loanData.loanTenure, '', '', '', ''],
            ['Compounding Frequency :', loanData.compoundingFrequency, '', '', '', ''],
            ['', '', '', '', '', ''],
            ['Calculated Results', '', '', '', '', ''],
            ['Monthly EMI (₹) :', loanData.monthlyEmi, '', '', '', ''],
            ['Total Interest (₹) :', loanData.totalInterest, '', '', '', ''],
            ['Total Payment (₹) :', loanData.totalPayment, '', '', '', ''],
            ['Interest Percentage :', loanData.interestPercent, '', '', '', ''],
            ['Number of EMIs :', loanData.numberOfEmis, '', '', '', ''],
            ['', '', '', '', '', ''],
            ['Amortization Schedule', '', '', '', '', ''],
            ['Payment No.', 'EMI Amount', 'Principal', 'Interest', 'Total Interest', 'Balance'],
        ];

        if (loanData.schedule && loanData.schedule.length > 0) {
            loanData.schedule.forEach(payment => {
                values.push([
                    payment.paymentNumber,
                    payment.emiAmount,
                    payment.principal,
                    payment.interest,
                    payment.totalInterest,
                    payment.balance
                ]);
            });
        }

        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: spreadsheetId,
            range: 'A1',
            valueInputOption: 'USER_ENTERED',
            resource: { values: values }
        });

        updateGoogleSheetsStatus(`Successfully saved! <a href="https://docs.google.com/spreadsheets/d/${spreadsheetId}" target="_blank" style="color: white; text-decoration: underline;">Open Spreadsheet</a>`, 'success');

    } catch (error) {
        updateGoogleSheetsStatus(`Error saving to Google Sheets: ${error.message}`, 'error');
    }
}

// === CORE HELPERS ===
function getPrimaryLoanTenureInYears() {
    const tenureValue = parseFloat(document.getElementById('loanTenure').value) || 0;
    const tenureType = document.getElementById('loanTenureType').value;
    return tenureType === 'months' ? tenureValue / 12 : tenureValue;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// === ADVANCED INPUTS & LOGIC ===
function getAdvancedInputs() {
    const balloonPayment = parseFloat(document.getElementById('balloonPayment').value) || 0;
    
    const rateRows = document.querySelectorAll('#variableRateBody tr');
    const variableRates = [];
    rateRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 3) {
            const fromYear = parseFloat(inputs[0].value);
            const toYear = parseFloat(inputs[1].value);
            const rate = parseFloat(inputs[2].value);
            
            // Only add if values are valid numbers
            if (!isNaN(fromYear) && !isNaN(toYear) && !isNaN(rate)) {
                variableRates.push({ fromYear, toYear, rate });
            }
        }
    });

    const prepayRows = document.querySelectorAll('#prepaymentBody tr');
    const prepayments = [];
    prepayRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 3) {
            const startMonth = parseFloat(inputs[0].value);
            const frequency = inputs[1].value;
            const amount = parseFloat(inputs[2].value);
            
            // Only add if values are valid numbers
            if (!isNaN(startMonth) && !isNaN(amount)) {
                prepayments.push({ startMonth, frequency, amount });
            }
        }
    });

    return { balloonPayment, variableRates, prepayments };
}

function calculateEMI(principal, annualRate, years, compoundingFreq) {
    const advanced = getAdvancedInputs();
    const monthlyRate = annualRate / 100 / 12;
    const numberOfPayments = Math.round(years * 12);
    
    let adjustedPrincipal = principal;
    if (advanced.balloonPayment > 0) {
        const pvBalloon = advanced.balloonPayment / Math.pow(1 + monthlyRate, numberOfPayments);
        adjustedPrincipal = principal - pvBalloon;
    }

    let emi;
    if (monthlyRate === 0) {
        emi = adjustedPrincipal / numberOfPayments;
    } else {
        emi = adjustedPrincipal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
    }
    
    const totalEmiPayment = emi * numberOfPayments;
    const totalPayment = totalEmiPayment + advanced.balloonPayment;
    const totalInterest = totalPayment - principal;
    
    if (isNaN(emi) || !isFinite(emi)) emi = 0;

    const interestPercent = totalPayment > 0 ? (totalInterest / totalPayment) * 100 : 0;
    
    return {
        emi: Math.round(emi),
        totalInterest: Math.round(totalInterest),
        totalPayment: Math.round(totalPayment),
        interestPercent: Math.round(interestPercent * 100) / 100,
        numberOfPayments: numberOfPayments
    };
}

function generateAmortizationSchedule(principal, initialAnnualRate, years, compoundingFreq) {
    const advanced = getAdvancedInputs();
    const initialCalculation = calculateEMI(principal, initialAnnualRate, years, compoundingFreq);
    
    let balance = principal;
    let totalInterestPaid = 0;
    const schedule = [];
    
    let currentEmi = initialCalculation.emi;
    let currentRate = initialAnnualRate;
    const totalMonths = initialCalculation.numberOfPayments;

    for (let month = 1; month <= totalMonths; month++) {
        let activeRate = initialAnnualRate;
        const currentYear = Math.ceil(month / 12);
        
        const rateOverride = advanced.variableRates.find(r => currentYear >= r.fromYear && currentYear <= r.toYear);
        if (rateOverride) activeRate = rateOverride.rate;

        if (activeRate !== currentRate) {
            currentRate = activeRate;
            const remainingMonths = totalMonths - (month - 1);
            const monthlyRateNew = currentRate / 100 / 12;
            
            let adjBal = balance;
            if (advanced.balloonPayment > 0) {
                const pvBalloon = advanced.balloonPayment / Math.pow(1 + monthlyRateNew, remainingMonths);
                adjBal = balance - pvBalloon;
            }
            
            currentEmi = adjBal * (monthlyRateNew * Math.pow(1 + monthlyRateNew, remainingMonths)) / (Math.pow(1 + monthlyRateNew, remainingMonths) - 1);
        }

        const monthlyRate = currentRate / 100 / 12;
        const interestPayment = Math.round(balance * monthlyRate);
        let principalPayment = Math.round(currentEmi - interestPayment);
        
        let extraPayment = 0;
        advanced.prepayments.forEach(pre => {
            if (month >= pre.startMonth) {
                let isDue = false;
                const monthFromStart = month - pre.startMonth;
                if (pre.frequency === 'monthly') isDue = true;
                if (pre.frequency === 'quarterly' && monthFromStart % 3 === 0) isDue = true;
                if (pre.frequency === 'half-yearly' && monthFromStart % 6 === 0) isDue = true;
                if (pre.frequency === 'yearly' && monthFromStart % 12 === 0) isDue = true;
                
                if (isDue) extraPayment += pre.amount;
            }
        });

        if (balance - principalPayment - extraPayment < 0) {
            extraPayment = balance - principalPayment;
            if (extraPayment < 0) {
                principalPayment = balance;
                extraPayment = 0;
            }
        }

        balance = Math.round(balance - principalPayment - extraPayment);
        totalInterestPaid += interestPayment;
        if (balance <= 0) balance = 0;

        schedule.push({
            paymentNumber: month,
            emiAmount: Math.round(currentEmi),
            principal: principalPayment + extraPayment,
            interest: interestPayment,
            totalInterest: totalInterestPaid,
            balance: balance
        });

        if (balance === 0) break;
    }
    
    return schedule;
}

function getCurrentLoanData() {
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const loanTenure = getPrimaryLoanTenureInYears();
    const tenureType = document.getElementById('loanTenureType').value;
    const tenureValue = document.getElementById('loanTenure').value;
    const compoundingFrequency = document.getElementById('compoundingFrequency').value;
    
    const calculation = calculateEMI(loanAmount, interestRate, loanTenure, compoundingFrequency);
    
    return {
        loanAmount: formatCurrency(loanAmount),
        interestRate: interestRate + '%',
        loanTenure: `${tenureValue} ${tenureType.charAt(0).toUpperCase() + tenureType.slice(1)}`,
        compoundingFrequency: compoundingFrequency,
        monthlyEmi: formatCurrency(calculation.emi),
        totalInterest: formatCurrency(calculation.totalInterest),
        totalPayment: formatCurrency(calculation.totalPayment),
        interestPercent: calculation.interestPercent + '%',
        numberOfEmis: calculation.numberOfPayments,
        schedule: generateAmortizationSchedule(loanAmount, interestRate, loanTenure, compoundingFrequency)
    };
}

let currentEmiData = { emi: 0, totalInterest: 0, totalPayment: 0, interestPercent: 0, numberOfPayments: 0 };

function updateLoanResults(calculation) {
    document.getElementById('emiValue').textContent = formatCurrency(calculation.emi);
    document.getElementById('totalInterest').textContent = formatCurrency(calculation.totalInterest);
    document.getElementById('totalPayment').textContent = formatCurrency(calculation.totalPayment);
    document.getElementById('interestPercent').textContent = calculation.interestPercent + '%';
    document.getElementById('numberOfEmis').textContent = calculation.numberOfPayments;
    
    const progressBar = document.getElementById('loanProgressBar');
    if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.textContent = '0% Repaid';
    }
    currentEmiData = calculation;
}

function generateScheduleTable(principal, annualRate, years, compoundingFreq) {
    const schedule = generateAmortizationSchedule(principal, annualRate, years, compoundingFreq);
    const tbody = document.getElementById('scheduleBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    schedule.forEach((payment, index) => {
        if (index < 12 || (payment.paymentNumber % 12 === 0) || index === schedule.length - 1) {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${payment.paymentNumber}</td>
                <td>${formatCurrency(payment.emiAmount)}</td>
                <td>${formatCurrency(payment.principal)}</td>
                <td>${formatCurrency(payment.interest)}</td>
                <td>${formatCurrency(payment.totalInterest)}</td>
                <td>${formatCurrency(payment.balance)}</td>
            `;
        }
    });
}

function createPaymentChart(principal, totalInterest) {
    const ctx = document.getElementById('paymentBreakdownChart');
    if (!ctx) return;
    if (window.paymentChart) window.paymentChart.destroy();
    
    window.paymentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Principal Amount', 'Interest Amount'],
            datasets: [{
                data: [principal, totalInterest],
                backgroundColor: ['#4361ee', '#7209b7'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } }
        }
    });
}

function createInterestHeatmap(principal, annualRate, years) {
    const heatmapContainer = document.getElementById('interestHeatmap');
    if (!heatmapContainer) return;
    
    const schedule = generateAmortizationSchedule(principal, annualRate, years, 'monthly');
    const totalMonths = schedule.length > 0 ? schedule.length : Math.round(years * 12);
    const cellsPerRow = 12;
    const rows = Math.ceil(totalMonths / cellsPerRow);
    
    heatmapContainer.style.gridTemplateColumns = `60px repeat(${cellsPerRow}, 1fr)`;
    heatmapContainer.innerHTML = '';
    
    const headerRow = ['Year'];
    for (let month = 1; month <= 12; month++) headerRow.push(month.toString());
    
    headerRow.forEach(header => {
        const cell = document.createElement('div');
        cell.className = 'heatmap-cell heatmap-header';
        cell.textContent = header;
        heatmapContainer.appendChild(cell);
    });
    
    const maxInterest = schedule.length > 0 ? Math.max(...schedule.map(s => s.interest)) : 1;
    
    for (let year = 1; year <= rows; year++) {
        const yearLabel = document.createElement('div');
        yearLabel.className = 'heatmap-cell heatmap-row-label';
        yearLabel.textContent = year.toString();
        heatmapContainer.appendChild(yearLabel);
        
        for (let month = 1; month <= 12; month++) {
            const scheduleIndex = (year - 1) * 12 + (month - 1);
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell';
            
            if (scheduleIndex < schedule.length) {
                const payment = schedule[scheduleIndex];
                const intensity = payment.interest / maxInterest;
                const red = Math.floor(255 * intensity);
                const blue = Math.floor(255 * (1 - intensity));
                
                cell.style.backgroundColor = `rgb(${red}, 100, ${blue})`;
                cell.textContent = formatCurrency(payment.interest).replace('₹', '').replace(',', 'k');
                cell.title = `Month ${scheduleIndex + 1}: ${formatCurrency(payment.interest)} interest`;
            } else {
                cell.style.backgroundColor = '#f0f0f0';
                cell.textContent = '-';
            }
            heatmapContainer.appendChild(cell);
        }
    }
}

// Export Functions
function exportToTXT() {
    const data = getCurrentLoanData();
    let content = `Loan Calculator Results\nGenerated on: ${new Date().toLocaleString()}\n\nBasic Loan Details:\nLoan Amount: ${data.loanAmount}\nInterest Rate: ${data.interestRate}\nLoan Tenure: ${data.loanTenure}\n\nCalculated Results:\nMonthly EMI: ${data.monthlyEmi}\nTotal Interest: ${data.totalInterest}\nTotal Payment: ${data.totalPayment}\n\n`;
    downloadFile(content, 'loan_calculator_results.txt', 'text/plain');
}

function exportToCSV() {
    const data = getCurrentLoanData();
    let content = `Loan Calculator Results\nGenerated on,${new Date().toLocaleString()}\n\nLoan Amount,${data.loanAmount}\nInterest Rate,${data.interestRate}\nLoan Tenure,${data.loanTenure}\nMonthly EMI,${data.monthlyEmi}\nTotal Interest,${data.totalInterest}\nTotal Payment,${data.totalPayment}\n\nPayment No.,EMI Amount,Principal,Interest,Total Interest,Balance\n`;
    if (data.schedule) {
        data.schedule.forEach(payment => {
            content += `${payment.paymentNumber},${payment.emiAmount},${payment.principal},${payment.interest},${payment.totalInterest},${payment.balance}\n`;
        });
    }
    downloadFile(content, 'loan_calculator_results.csv', 'text/csv');
}

function exportToMD() {
    const data = getCurrentLoanData();
    let content = `# Loan Calculator Results\n\n**Generated on:** ${new Date().toLocaleString()}\n\n## Loan Details\n- **Amount:** ${data.loanAmount}\n- **Interest:** ${data.interestRate}\n- **Tenure:** ${data.loanTenure}\n\n## Results\n- **EMI:** ${data.monthlyEmi}\n- **Total Interest:** ${data.totalInterest}\n`;
    downloadFile(content, 'loan_calculator_results.md', 'text/markdown');
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const data = getCurrentLoanData();
    doc.setFontSize(20); doc.text('Loan Calculator Results', 105, 20, { align: 'center' });
    doc.setFontSize(12); doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 40);
    doc.text(`Loan Amount: ${data.loanAmount}`, 20, 60);
    doc.text(`Interest Rate: ${data.interestRate}`, 20, 70);
    doc.text(`Loan Tenure: ${data.loanTenure}`, 20, 80);
    doc.text(`Monthly EMI: ${data.monthlyEmi}`, 20, 100);
    doc.text(`Total Payment: ${data.totalPayment}`, 20, 110);
    doc.save('loan_calculator_results.pdf');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type: type });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    window.URL.revokeObjectURL(url);
}

// Tab & Slider Logic
function initializeTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
}

function initializeDarkMode() {
    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;
    darkModeToggle.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        darkModeToggle.innerHTML = body.classList.contains('dark-mode') ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    });
}

function initializeSliders() {
    const loanAmountSlider = document.getElementById('loanAmountSlider');
    const loanAmountInput = document.getElementById('loanAmount');
    const interestRateSlider = document.getElementById('interestRateSlider');
    const interestRateInput = document.getElementById('interestRate');
    const loanTenureSlider = document.getElementById('loanTenureSlider');
    const loanTenureInput = document.getElementById('loanTenure');
    const loanTenureType = document.getElementById('loanTenureType');
    const loanTenureSliderValues = document.getElementById('loanTenureSliderValues');
    
    if (loanAmountSlider && loanAmountInput) {
        loanAmountSlider.addEventListener('input', (e) => { loanAmountInput.value = e.target.value; calculateAndUpdate(); });
        loanAmountInput.addEventListener('input', (e) => { loanAmountSlider.value = e.target.value; calculateAndUpdate(); });
    }
    if (interestRateSlider && interestRateInput) {
        interestRateSlider.addEventListener('input', (e) => { interestRateInput.value = e.target.value; calculateAndUpdate(); });
        interestRateInput.addEventListener('input', (e) => { interestRateSlider.value = e.target.value; calculateAndUpdate(); });
    }
    if (loanTenureSlider && loanTenureInput && loanTenureType) {
        loanTenureType.addEventListener('change', (e) => {
            const currentValue = parseFloat(loanTenureInput.value) || 0;
            if (e.target.value === 'months') {
                const newValue = Math.round(currentValue * 12);
                loanTenureSlider.max = 360;
                loanTenureSlider.step = 1;
                loanTenureSlider.value = newValue;
                loanTenureInput.value = newValue;
                loanTenureSliderValues.innerHTML = `<span>1 Month</span><span>360 Months</span>`;
            } else {
                const newValue = Math.max(1, Math.round(currentValue / 12));
                loanTenureSlider.max = 30;
                loanTenureSlider.step = 1;
                loanTenureSlider.value = newValue;
                loanTenureInput.value = newValue;
                loanTenureSliderValues.innerHTML = `<span>1 Year</span><span>30 Years</span>`;
            }
            calculateAndUpdate();
        });
        loanTenureSlider.addEventListener('input', (e) => { loanTenureInput.value = e.target.value; calculateAndUpdate(); });
        loanTenureInput.addEventListener('input', (e) => {
            const maxVal = loanTenureType.value === 'months' ? 360 : 30;
            loanTenureSlider.value = Math.min(e.target.value, maxVal);
            calculateAndUpdate();
        });
    }
}

function calculateAndUpdate() {
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const loanTenure = getPrimaryLoanTenureInYears();
    const compoundingFrequency = document.getElementById('compoundingFrequency').value;
    
    if (loanAmount && interestRate && loanTenure) {
        const calculation = calculateEMI(loanAmount, interestRate, loanTenure, compoundingFrequency);
        updateLoanResults(calculation);
        generateScheduleTable(loanAmount, interestRate, loanTenure, compoundingFrequency);
        createPaymentChart(loanAmount, calculation.totalInterest);
        createInterestHeatmap(loanAmount, interestRate, loanTenure);
    }
}

// Scenario, Tax, Portfolio & Affordability Handlers
function calculateHomeLoanTax() {
    const loanAmount = parseFloat(document.getElementById('hlLoanAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('hlInterestRate').value) || 0;
    const tenureValue = parseFloat(document.getElementById('hlTenure').value) || 0;
    const tenureType = document.getElementById('hlTenureType').value;
    const tenure = (tenureType === 'months') ? tenureValue / 12 : tenureValue;
    const taxSlab = parseFloat(document.getElementById('taxSlab').value) || 0;
    
    if (!loanAmount || !interestRate || !tenure) return;
    const calculation = calculateEMI(loanAmount, interestRate, tenure, 'monthly');
    const yearlyEmi = calculation.emi * 12;
    const yearlyInterest = Math.min(calculation.emi * 12 * 0.7, 200000);
    const yearlyPrincipal = Math.min(calculation.emi * 12 * 0.3, 150000);
    const totalDeduction = yearlyInterest + yearlyPrincipal;
    const taxSaving = totalDeduction * taxSlab;
    const effectiveRate = interestRate - (taxSaving / yearlyEmi) * 100;
    
    document.getElementById('yearlyTaxSaving').textContent = formatCurrency(taxSaving);
    document.getElementById('principal80C').textContent = formatCurrency(yearlyPrincipal);
    document.getElementById('interest24b').textContent = formatCurrency(yearlyInterest);
    document.getElementById('totalDeduction').textContent = formatCurrency(totalDeduction);
    document.getElementById('effectiveRate').textContent = effectiveRate.toFixed(1) + '%';
}

function calculatePortfolioEMI() {
    const tbody = document.getElementById('portfolioBody');
    const rows = tbody.querySelectorAll('tr');
    let totalEMI = 0;
    let loanCount = 0;
    let longestTenure = 0;
    const loans = [];
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 6) { 
            const loanName = inputs[0].value || 'Unnamed Loan';
            const amount = parseFloat(inputs[1].value) || 0;
            const rate = parseFloat(inputs[2].value) || 0;
            const tenureValue = parseFloat(inputs[3].value) || 0;
            const tenureType = inputs[4].value;
            const tenure = (tenureType === 'months') ? tenureValue / 12 : tenureValue;
            const compounding = inputs[5].value; 
            
            if (amount > 0 && rate > 0 && tenure > 0) {
                const calculation = calculateEMI(amount, rate, tenure, compounding);
                totalEMI += calculation.emi;
                loanCount++;
                longestTenure = Math.max(longestTenure, tenure);
                loans.push({ name: loanName, emi: calculation.emi, tenure: tenure });
            }
        }
    });
    
    document.getElementById('totalPortfolioEmi').textContent = formatCurrency(totalEMI);
    document.getElementById('portfolioLoanCount').textContent = loanCount;
    document.getElementById('portfolioLongestTenure').textContent = longestTenure.toFixed(1) + ' Years';
    
    // Update Chart
    const ctx = document.getElementById('portfolioEmiChart');
    if (ctx && loans.length > 0) {
        if (window.portfolioChart) window.portfolioChart.destroy();
        const maxTenure = Math.max(...loans.map(l => l.tenure));
        const months = Array.from({length: Math.round(maxTenure * 12)}, (_, i) => i + 1);
        const datasets = loans.map((loan, index) => ({
            label: loan.name,
            data: months.map(month => month <= loan.tenure * 12 ? loan.emi : 0),
            backgroundColor: `hsla(${index * 360 / loans.length}, 70%, 50%, 0.7)`,
        }));
        window.portfolioChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months.filter((_, i) => i % 12 === 0).map(m => `Year ${Math.ceil(m/12)}`),
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: v => '₹' + v } } }
            }
        });
    }
}

function addLoanRow() {
    const tbody = document.getElementById('portfolioBody');
    const row = tbody.insertRow();
    row.innerHTML = `<td><input type="text" value="Loan"></td><td><input type="number" value="100000"></td><td><input type="number" value="10"></td><td><div style="display:flex;gap:5px;"><input type="number" value="1"><select style="flex:1"><option value="years">Years</option><option value="months">Months</option></select></div></td><td><select><option>Monthly</option></select></td><td><button class="remove-loan-row"><i class="fas fa-trash"></i></button></td>`;
    row.querySelector('.remove-loan-row').addEventListener('click', () => row.remove());
}

function calculateAffordableLoan() {
    const affordableEmi = parseFloat(document.getElementById('affordableEmi').value) || 0;
    const interestRate = parseFloat(document.getElementById('affordabilityInterestRate').value) || 0;
    const tenureValue = parseFloat(document.getElementById('affordabilityTenure').value) || 0;
    const tenureType = document.getElementById('affordabilityTenureType').value;
    const tenure = (tenureType === 'months') ? tenureValue / 12 : tenureValue;
    
    if (!affordableEmi || !interestRate || !tenure) return;
    const monthlyRate = interestRate / 100 / 12;
    const numberOfPayments = tenure * 12;
    const maxLoanAmount = affordableEmi * (Math.pow(1 + monthlyRate, numberOfPayments) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments));
    const totalPayment = affordableEmi * numberOfPayments;
    const totalInterest = totalPayment - maxLoanAmount;
    
    document.getElementById('maxAffordableLoan').textContent = formatCurrency(maxLoanAmount);
    document.getElementById('affordableTotalInterest').textContent = formatCurrency(totalInterest);
    document.getElementById('affordableTotalPayment').textContent = formatCurrency(totalPayment);
}

function calculateDTI() {
    const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;
    const currentEmi = currentEmiData.emi || 0;
    if (!monthlyIncome) return;
    const dtiRatio = (currentEmi / monthlyIncome) * 100;
    document.getElementById('currentEmiForDti').textContent = formatCurrency(currentEmi);
    document.getElementById('dtiRatio').textContent = dtiRatio.toFixed(1) + '%';
    
    const risk = document.getElementById('dtiRiskAssessment');
    if (dtiRatio <= 30) { risk.textContent = "Healthy DTI"; risk.style.background = "#4CAF50"; }
    else if (dtiRatio <= 50) { risk.textContent = "Moderate DTI"; risk.style.background = "#FF9800"; }
    else { risk.textContent = "High Risk DTI"; risk.style.background = "#F44336"; }
}

function calculateEmiScenario() {
    const extraEmi = parseFloat(document.getElementById('extraEmi').value) || 0;
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const loanTenure = getPrimaryLoanTenureInYears();
    const original = calculateEMI(loanAmount, interestRate, loanTenure, 'monthly');
    const newEmi = original.emi + extraEmi;
    const monthlyRate = interestRate/100/12;
    let months = 0;
    let bal = loanAmount;
    while(bal > 0 && months < 600) {
        bal = bal - (newEmi - (bal * monthlyRate));
        months++;
    }
    const saved = original.totalInterest - ((newEmi * months) - loanAmount);
    document.getElementById('emiSavings').innerHTML = `New Tenure: ${Math.floor(months/12)}Y ${months%12}M <br> Saved: ${formatCurrency(saved)}`;
}

function calculatePrepaymentScenario() {
    const prepay = parseFloat(document.getElementById('prepaymentAmount').value) || 0;
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const loanTenure = getPrimaryLoanTenureInYears();
    const original = calculateEMI(loanAmount, interestRate, loanTenure, 'monthly');
    const newPrincipal = loanAmount - prepay;
    if(newPrincipal <= 0) {
        document.getElementById('prepaymentSavings').innerHTML = "Loan fully paid off!";
        return;
    }
    const newCalc = calculateEMI(newPrincipal, interestRate, loanTenure, 'monthly');
    const saved = original.totalInterest - newCalc.totalInterest;
    document.getElementById('prepaymentSavings').innerHTML = `New EMI: ${formatCurrency(newCalc.emi)} <br> Saved: ${formatCurrency(saved)}`;
}

function addVariableRateRow() {
    const tbody = document.getElementById('variableRateBody');
    const row = tbody.insertRow();
    row.innerHTML = `<td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><button class="remove-row"><i class="fas fa-trash"></i></button></td>`;
    row.querySelector('.remove-row').addEventListener('click', () => row.remove());
}
function addPrepaymentRow() {
    const tbody = document.getElementById('prepaymentBody');
    const row = tbody.insertRow();
    row.innerHTML = `<td><input type="number"></td><td><select><option value="monthly">Monthly</option></select></td><td><input type="number"></td><td><button class="remove-row"><i class="fas fa-trash"></i></button></td>`;
    row.querySelector('.remove-row').addEventListener('click', () => row.remove());
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    initializeTabs();
    initializeDarkMode();
    initializeSliders();
    
    const toggles = document.querySelectorAll('.option-toggle');
    toggles.forEach(toggle => {
        toggle.addEventListener('click', () => {
            toggle.nextElementSibling.classList.toggle('active');
        });
    });

    document.getElementById('calculateBtn').addEventListener('click', calculateAndUpdate);
    document.getElementById('exportTxtBtn').addEventListener('click', exportToTXT);
    document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
    document.getElementById('exportMdBtn').addEventListener('click', exportToMD);
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    document.getElementById('saveToGoogleSheetsBtn').addEventListener('click', saveToGoogleSheets);
    
    if(document.getElementById('calculateHlBtn')) document.getElementById('calculateHlBtn').addEventListener('click', calculateHomeLoanTax);
    if(document.getElementById('calculateEmiScenario')) document.getElementById('calculateEmiScenario').addEventListener('click', calculateEmiScenario);
    if(document.getElementById('calculatePrepaymentScenario')) document.getElementById('calculatePrepaymentScenario').addEventListener('click', calculatePrepaymentScenario);
    
    if(document.querySelector('.add-loan-row')) document.querySelector('.add-loan-row').addEventListener('click', addLoanRow);
    if(document.getElementById('calculatePortfolioBtn')) document.getElementById('calculatePortfolioBtn').addEventListener('click', calculatePortfolioEMI);
    
    if(document.getElementById('calculateAffordableLoanBtn')) document.getElementById('calculateAffordableLoanBtn').addEventListener('click', calculateAffordableLoan);
    if(document.getElementById('calculateDtiBtn')) document.getElementById('calculateDtiBtn').addEventListener('click', calculateDTI);

    if(document.querySelector('.add-rate-row')) document.querySelector('.add-rate-row').addEventListener('click', addVariableRateRow);
    if(document.querySelector('.add-prepayment-row')) document.querySelector('.add-prepayment-row').addEventListener('click', addPrepaymentRow);
    
    document.querySelectorAll('.remove-loan-row').forEach(btn => btn.addEventListener('click', function() { btn.closest('tr').remove(); }));
    document.querySelectorAll('.remove-row').forEach(btn => btn.addEventListener('click', function() { btn.closest('tr').remove(); }));

    calculateAndUpdate();
    
    setTimeout(() => {
        if (typeof gapi !== 'undefined') updateGoogleSheetsStatus('Ready to save.', 'success');
    }, 2000);
});
    </script>
</body>
</html>
